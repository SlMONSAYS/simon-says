<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>diary — simon's little corner</title>
  <link rel="stylesheet" href="../style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400&display=swap" rel="stylesheet" />

  <!-- marked.js — parses Markdown into HTML. Loaded from CDN, no install needed. -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="page-wrap">

  <!-- ============================================================
       DIARY ENTRY CONFIG
       The password hash must match what's in diary/index.html.
       Copy/paste it here whenever you change it there.
       ============================================================ -->
  <script>
    const DIARY_PASSWORD_HASH = "e9c6d1605c7561e417c92bac47b6b0afa951d18cee96a40bb7186998abcbf4ea";

    // Folder where .md entry files live (relative to this file)
    const ENTRIES_FOLDER = "entries/";
  </script>

  <header>
    <h1 class="site-title"><a href="../" class="site-title-link">simon's little corner</a></h1>
  </header>

  <main id="main-content">
    <!-- Content is injected by JS after password check -->
    <p class="state-msg" id="loading-msg">checking...</p>
  </main>

  <footer>
    <a href="index.html" class="diary-link" id="back-link" style="display:none">← diary</a>
  </footer>

</div>

<script>
  // ============================================================
  // PASSWORD CHECK (same logic as diary/index.html)
  // ============================================================
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function showPasswordScreen() {
    const main = document.getElementById("main-content");
    main.innerHTML = `
      <div class="password-screen">
        <p>ask simon for the super secret password :p</p>
        <form class="password-form" id="pw-form" autocomplete="off">
          <input
            type="password"
            id="pw-input"
            placeholder="password"
            aria-label="diary password"
            autofocus
          />
          <button type="submit">enter</button>
        </form>
        <span class="pw-error" id="pw-error" aria-live="polite"></span>
      </div>
    `;

    document.getElementById("pw-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const input = document.getElementById("pw-input").value;
      const hash = await hashPassword(input);

      if (hash === DIARY_PASSWORD_HASH) {
        sessionStorage.setItem("diary-unlocked", "true");
        loadEntry();
      } else {
        document.getElementById("pw-error").textContent = "that's not it.";
        document.getElementById("pw-input").value = "";
        document.getElementById("pw-input").focus();
      }
    });
  }

  // ============================================================
  // ENTRY LOADING
  // Gets the filename from the URL query string (?entry=...)
  // fetches the .md file, parses it with marked.js, and renders it.
  // ============================================================
  async function loadEntry() {
    const params = new URLSearchParams(window.location.search);
    const filename = params.get("entry");

    if (!filename) {
      showError("no entry specified.");
      return;
    }

    // Basic safety check — only allow simple filenames, no path traversal
    if (!/^[\w\-\.]+\.md$/.test(filename)) {
      showError("invalid entry.");
      return;
    }

    const main = document.getElementById("main-content");
    main.innerHTML = '<p class="state-msg">loading...</p>';

    try {
      const response = await fetch(ENTRIES_FOLDER + filename);

      if (!response.ok) {
        showError("entry not found.");
        return;
      }

      const markdown = await response.text();

      // Pull the first # heading out as the page title, and the date
      // from a line starting with "date:" if present.
      // Falls back gracefully if neither exist.
      const titleMatch = markdown.match(/^#\s+(.+)/m);
      const dateMatch  = markdown.match(/^date:\s*(.+)/im);

      const title = titleMatch ? titleMatch[1].trim() : filename.replace(".md", "");
      const date  = dateMatch  ? dateMatch[1].trim()  : "";

      // Update the browser tab title
      document.title = `${title} — simon's little corner`;

      // Strip the title heading and date line before rendering
      // so they don't appear twice (they're shown in entry-header above)
      const bodyMarkdown = markdown
        .replace(/^#\s+.+\n?/m, "")
        .replace(/^date:\s*.+\n?/im, "")
        .trim();

      // Render Markdown to HTML
      const html = marked.parse(bodyMarkdown);

      main.innerHTML = `
        <a href="index.html" class="back-link">← diary</a>
        <div class="entry-header">
          ${date ? `<span class="entry-date">${date}</span>` : ""}
          <h1>${title}</h1>
        </div>
        <div class="entry-body">${html}</div>
      `;

    } catch (err) {
      showError("couldn't load entry.");
    }
  }

  function showError(msg) {
    document.getElementById("main-content").innerHTML =
      `<p class="state-msg">${msg} <a href="index.html" style="color:var(--accent-light)">go back</a></p>`;
  }

  // ============================================================
  // INIT — check session, then either show password or load entry
  // ============================================================
  if (sessionStorage.getItem("diary-unlocked") === "true") {
    loadEntry();
  } else {
    document.getElementById("loading-msg").remove();
    showPasswordScreen();
  }
</script>

</body>
</html>
